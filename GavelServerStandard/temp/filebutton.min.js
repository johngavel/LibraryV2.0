import {
  NavButton
} from "/js/buttons.js";
class DownloadButton extends NavButton {
  static get observedAttributes() {
    return [...super.observedAttributes, "url", "filename"]
  }
  constructor() {
    super(), this._button && this._button.textContent.trim() || (this._button.textContent = "Download"), this._onClick = this._onClick.bind(this), this._button.addEventListener("click", this._onClick, {
      capture: !0
    })
  }
  get url() {
    return this.getAttribute("url") || this.link || "/api/download.json"
  }
  set url(t) {
    null == t ? this.removeAttribute("url") : this.setAttribute("url", String(t))
  }
  get filename() {
    return this.getAttribute("filename") || "download"
  }
  set filename(t) {
    null == t ? this.removeAttribute("filename") : this.setAttribute("filename", String(t))
  }
  async _onClick(t) {
    if (t.preventDefault(), t.stopImmediatePropagation(), !this.disabled) {
      t = this._button.textContent;
      this._button.disabled = !0, this._button.textContent = "Downloading…", this._button.setAttribute("aria-busy", "true");
      try {
        var e = await fetch(this.url, {
          method: "GET",
          headers: {
            "Content-Type": "application/json"
          }
        });
        if (!e.ok) throw new Error("HTTP " + e.status);
        var i = await e.blob(),
          n = URL.createObjectURL(i),
          s = document.createElement("a");
        s.href = n, s.download = this.filename, document.body.appendChild(s), s.click(), s.remove(), URL.revokeObjectURL(n), this.dispatchEvent(new CustomEvent("download-success", {
          detail: {
            response: e,
            filename: this.filename
          },
          bubbles: !0
        }))
      } catch (t) {
        console.error("download-button error:", t), this.dispatchEvent(new CustomEvent("download-error", {
          detail: {
            error: t
          },
          bubbles: !0
        })), alert("Download failed.")
      } finally {
        this._button.disabled = !1, this._button.textContent = t || "Download", this._button.removeAttribute("aria-busy")
      }
    }
  }
  disconnectedCallback() {
    this._button && this._onClick && this._button.removeEventListener("click", this._onClick, {
      capture: !0
    }), super.disconnectedCallback?.()
  }
}
class UploadButton extends NavButton {
  static get observedAttributes() {
    return [...super.observedAttributes, "endpoint", "accept"]
  }
  constructor() {
    super(), this._button && this._button.textContent.trim() || (this._button.textContent = "Upload"), this._onClick = this._onClick.bind(this), this._button.addEventListener("click", this._onClick, {
      capture: !0
    }), this._input = document.createElement("input"), this._input.type = "file", this._input.style.display = "none", this._input.multiple = !1, this._defaultAccept = "application/json,application/ld+json,.json", this._input.addEventListener("change", () => this._handleFile(this._input.files?.[0] || null)), this.appendChild(this._input)
  }
  get endpoint() {
    return this.getAttribute("endpoint") || "/api/upload.json"
  }
  set endpoint(t) {
    null == t ? this.removeAttribute("endpoint") : this.setAttribute("endpoint", String(t))
  }
  get accept() {
    return this.getAttribute("accept") || this._defaultAccept
  }
  set accept(t) {
    null == t ? this.removeAttribute("accept") : this.setAttribute("accept", String(t))
  }
  attributeChangedCallback(t, e, i) {
    super.attributeChangedCallback?.(t, e, i), this._input && "accept" === t && (this._input.accept = this.accept)
  }
  connectedCallback() {
    super.connectedCallback?.(), this._input && (this._input.accept = this.accept, this._input.multiple = !1)
  }
  _onClick(t) {
    t.preventDefault(), t.stopImmediatePropagation(), this.disabled || this._input.click()
  }
  async _handleFile(e) {
    if (e) {
      var t = this._button.textContent;
      this._button.disabled = !0, this._button.textContent = "Uploading…", this._button.setAttribute("aria-busy", "true");
      try {
        var i = await this._readAsText(e);
        try {
          JSON.parse(i)
        } catch {}
        var n = await fetch(this.endpoint, {
          method: "POST",
          headers: {
            "Content-Type": e.type || "application/json"
          },
          body: i
        });
        if (!n.ok) throw new Error("HTTP " + n.status);
        let t = null;
        try {
          t = await n.json()
        } catch {}
        this.dispatchEvent(new CustomEvent("upload-success", {
          detail: {
            response: n,
            data: t
          },
          bubbles: !0
        }))
      } catch (t) {
        console.error("upload-button error:", t), this.dispatchEvent(new CustomEvent("upload-error", {
          detail: {
            error: t
          },
          bubbles: !0
        })), alert("Upload failed.")
      } finally {
        this._button.disabled = !1, this._button.textContent = t || "Upload", this._button.removeAttribute("aria-busy"), this._input.value = "", window.location.reload(!0)
      }
    }
  }
  _readAsText(n) {
    return new Promise((t, e) => {
      const i = new FileReader;
      i.onerror = () => e(i.error), i.onload = () => t(String(i.result)), i.readAsText(n)
    })
  }
  disconnectedCallback() {
    this._button && this._onClick && this._button.removeEventListener("click", this._onClick, {
      capture: !0
    }), super.disconnectedCallback?.()
  }
}
class UpgradeButton extends NavButton {
  static get observedAttributes() {
    return [...super.observedAttributes, "upload-url", "upgrade-url", "accept", "max-size", "delay", "redirect"]
  }
  constructor() {
    super(), this._button && this._button.textContent?.trim() || (this._button.textContent = "Upgrade"), this._onClick = this._onClick.bind(this), this._button.addEventListener("click", this._onClick, {
      capture: !0
    })
  }
  get uploadUrl() {
    return this.getAttribute("upload-url") || "/var/pico.bin"
  }
  set uploadUrl(t) {
    null == t ? this.removeAttribute("upload-url") : this.setAttribute("upload-url", String(t))
  }
  get upgradeUrl() {
    return this.getAttribute("upgrade-url") || "/api/upgrade.json"
  }
  set upgradeUrl(t) {
    null == t ? this.removeAttribute("upgrade-url") : this.setAttribute("upgrade-url", String(t))
  }
  get accept() {
    return this.getAttribute("accept") || "application/octet-stream,.bin"
  }
  set accept(t) {
    null == t ? this.removeAttribute("accept") : this.setAttribute("accept", String(t))
  }
  get maxSize() {
    var t = this.getAttribute("max-size");
    return null == t ? 1048576 : Number(t)
  }
  set maxSize(t) {
    null == t ? this.removeAttribute("max-size") : this.setAttribute("max-size", String(t))
  }
  get delay() {
    var t = this.getAttribute("delay");
    return null == t ? 1e4 : Number(t)
  }
  set delay(t) {
    null == t ? this.removeAttribute("delay") : this.setAttribute("delay", String(t))
  }
  get redirect() {
    return this.getAttribute("redirect") || "/index.html"
  }
  set redirect(t) {
    null == t ? this.removeAttribute("redirect") : this.setAttribute("redirect", String(t))
  }
  _onClick(t) {
    if (t.preventDefault(), t.stopImmediatePropagation(), !this.disabled) {
      const r = document.createElement("input");
      r.type = "file", r.accept = this.accept, r.multiple = !1, r.style.display = "none", this.appendChild(r);
      r.addEventListener("change", async () => {
        try {
          var t = r.files?.[0] || null;
          if (r.remove(), t)
            if (/\.bin$/i.test(t.name))
              if (0 === t.size) alert("Selected file is empty.");
              else if (t.size > this.maxSize) alert(`File too large (${t.size} bytes). Max allowed is ${this.maxSize} bytes.`);
          else {
            this._button.textContent;
            this._setBusy(!0, "Uploading…");
            var e, i = await fetch(this.uploadUrl, {
              method: "POST",
              body: t
            });
            if (!i.ok) throw e = await this._safeText(i), new Error(`Upload failed: HTTP ${i.status} ` + i.statusText + (e ? " — " + e : ""));
            this._setBusy(!0, "Applying…");
            var n, s = await fetch(this.upgradeUrl, {
              method: "POST"
            });
            if (!s.ok) throw n = await this._safeText(s), new Error(`Upgrade failed: HTTP ${s.status} ` + s.statusText + (n ? " — " + n : ""));
            setTimeout(() => window.location.replace(this.redirect), this.delay)
          } else alert("Please choose a .bin firmware file.")
        } catch (t) {
          console.error("upgrade-button error:", t), alert(t?.message || "Upgrade failed. Please check server logs and try again."), this._setBusy(!1, "Upgrade")
        }
      }, {
        once: !0
      }), r.click()
    }
  }
  _setBusy(t, e) {
    this._button.disabled = t, this._button.textContent = e ?? (t ? "Working…" : "Upgrade"), this._button.toggleAttribute("aria-busy", t)
  }
  async _safeText(t) {
    try {
      return await t.text()
    } catch {
      return ""
    }
  }
  disconnectedCallback() {
    this._button && this._onClick && this._button.removeEventListener("click", this._onClick, {
      capture: !0
    }), super.disconnectedCallback?.()
  }
}
customElements.define("upgrade-button", UpgradeButton), customElements.define("upload-button", UploadButton), customElements.define("download-button", DownloadButton);
export {
  DownloadButton,
  UploadButton,
  UpgradeButton
};